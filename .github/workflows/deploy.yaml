---
name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/deploy.yaml'
  workflow_dispatch:
    inputs:
      limit:
        description: Limit deployment to specific hosts (e.g., big-slice,small-slice-01)
        required: false
        type: string

jobs:
  deploy:
    name: Ansible Deployment
    runs-on: self-hosted
    concurrency: production
    environment:
      name: production
    env:
      ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}/.ansible/collections
      ANSIBLE_ROLES_PATH: ${{ github.workspace }}/.ansible/roles
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure --color=always

      - name: Dry run Ansible playbook
        uses: dawidd6/action-ansible-playbook@v5
        with:
          playbook: site.yml
          requirements: requirements.yml
          vault_password: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          options: --check --diff ${{ inputs.limit && format('--limit {0}', inputs.limit) || '' }}

      - name: Run Ansible playbook
        uses: dawidd6/action-ansible-playbook@v5
        with:
          playbook: site.yml
          requirements: requirements.yml
          vault_password: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          options: ${{ inputs.limit && format('--limit {0}', inputs.limit) || '' }}
